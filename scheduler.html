<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Shared When2Meet with Firebase</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script> 

<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
  label { display: block; margin-top: 10px; }
  .day-label { font-weight: bold; margin-top: 20px; }
  .grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 2px;
    margin-bottom: 20px;
  }
  .block {
    border: 1px solid #ccc;
    padding: 4px 2px;
    text-align: center;
    font-size: 10px;
    cursor: pointer;
    user-select: none;
    background-color: #eee;
    transition: background-color 0.3s;
  }
  .block.selected {
    outline: 2px solid #339933;
  }
  .heat0 { background-color: #eee; }
  .heat1 { background-color: #ccffcc; }
  .heat2 { background-color: #99ee99; }
  .heat3 { background-color: #66cc66; }
  .heat4 { background-color: #339933; color: white; }
  .heat5plus { background-color: #267326; color: white; }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    cursor: pointer;
  }
  #output {
    white-space: pre-wrap;
    background: #f4f4f4;
    padding: 10px;
    margin-top: 10px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
  }
  #eventLink {
    margin-top: 10px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Shared When2Meet Clone</h1>

<label>
  Event Timezone:
  <select id="eventTimezone"></select>
</label>

<label>
  Event Start Date:
  <input type="date" id="startDate" />
</label>

<label>
  Event End Date:
  <input type="date" id="endDate" />
</label>

<button id="buildGridBtn">Build Availability Grid</button>

<hr />

<h3>Your Availability</h3>
<label>
  Your Name:
  <input type="text" id="participantName" placeholder="Your name" />
</label>

<label>
  Your Timezone:
  <select id="participantTimezone"></select>
</label>

<button id="submitBtn">Submit Availability</button>

<div id="eventLink"></div>

<div id="gridContainer"></div>

<pre id="output"></pre>

<script>
  // Initialize Luxon
  const DateTime = luxon.DateTime;

  // Static timezone list (common ones)
  const tzList = [
    "UTC",
    "America/New_York",
    "America/Chicago",
    "America/Denver",
    "America/Los_Angeles",
    "Europe/London",
    "Europe/Paris",
    "Europe/Berlin",
    "Asia/Tokyo",
    "Asia/Singapore",
    "Australia/Sydney"
  ];

  // Populate timezone selects
  const eventTzSelect = document.getElementById('eventTimezone');
  const participantTzSelect = document.getElementById('participantTimezone');

  tzList.forEach(tz => {
    const opt1 = new Option(tz, tz);
    const opt2 = new Option(tz, tz);
    eventTzSelect.appendChild(opt1);
    participantTzSelect.appendChild(opt2);
  });

  eventTzSelect.value = 'UTC';
  participantTzSelect.value = DateTime.local().zoneName;

  // Firebase config - REPLACE these with your own project's config!

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyBP_79ISSzVFqhx1PUSFaJNrscc7fRkGzA",
      authDomain: "when2meet-time.firebaseapp.com",
      projectId: "when2meet-time",
      storageBucket: "when2meet-time.firebasestorage.app",
      messagingSenderId: "749025517505",
      appId: "1:749025517505:web:4c6301971c9bf78d425940",
      measurementId: "G-BXQZK66GR0"
    };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Utility: generate random event ID
  function generateEventId(length = 6) {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let id = '';
    for (let i=0; i<length; i++) {
      id += chars.charAt(Math.floor(Math.random()*chars.length));
    }
    return id;
  }

  // Handle event ID in URL or generate new
  const urlParams = new URLSearchParams(window.location.search);
  let eventId = urlParams.get('event');
  if (!eventId) {
    eventId = generateEventId();
    urlParams.set('event', eventId);
    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    window.history.replaceState(null, '', newUrl);
  }

  document.getElementById('eventLink').innerHTML = `Share this event link: <a href="${window.location.href}" target="_blank">${window.location.href}</a>`;

  // UI Elements
  const gridContainer = document.getElementById('gridContainer');
  const output = document.getElementById('output');
  const participantNameInput = document.getElementById('participantName');
  const buildGridBtn = document.getElementById('buildGridBtn');
  const submitBtn = document.getElementById('submitBtn');

  // Store selected blocks dataset.time in a Set for fast lookup
  let selectedTimes = new Set();

  // Store merged availability counts for heatmap
  let mergedAvailability = {};

  // Build the availability grid
  function buildGrid() {
    gridContainer.innerHTML = '';
    selectedTimes.clear();
    mergedAvailability = {};

    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const eventTz = eventTzSelect.value;
    const userTz = participantTzSelect.value;

    if (!start || !end) {
      alert("Please select both start and end dates");
      return;
    }

    const startDate = DateTime.fromISO(start, { zone: eventTz });
    const endDate = DateTime.fromISO(end, { zone: eventTz });

    // if (endDate < startDate) {
    //   alert("End date must be the same or after start date");
    //   return;
    // }

    for (let day = startDate; day <= endDate; day = day.plus({ days: 1 })) {
      const dayLabel = document.createElement('div');
      dayLabel.className = 'day-label';
      dayLabel.textContent = day.toFormat('cccc, LLL dd, yyyy');
      gridContainer.appendChild(dayLabel);

      const grid = document.createElement('div');
      grid.className = 'grid';
      gridContainer.appendChild(grid);

      for (let i = 0; i < 96; i++) {
        const dtEvent = day.startOf('day').plus({ minutes: i * 15 });
        const dtUser = dtEvent.setZone(userTz);

        const block = document.createElement('div');
        block.className = 'block heat0';
        block.textContent = dtUser.toFormat('hh:mm a');
        block.dataset.time = dtEvent.toISO();

        block.addEventListener('click', () => {
          if (block.classList.contains('selected')) {
            block.classList.remove('selected');
            selectedTimes.delete(block.dataset.time);
          } else {
            block.classList.add('selected');
            selectedTimes.add(block.dataset.time);
          }
        });

        grid.appendChild(block);
      }
    }
    loadAllAvailability(); // load existing availability for heatmap
  }

  // Submit availability to Firestore
  async function submitAvailability() {
    const name = participantNameInput.value.trim() || 'Anonymous';
    const userTz = participantTzSelect.value;

    if (!name) {
      alert("Please enter your name");
      return;
    }

    if (selectedTimes.size === 0) {
      alert("Please select some availability blocks");
      return;
    }

    const availabilityArray = Array.from(selectedTimes);

    try {
      await db.collection('events')
        .doc(eventId)
        .collection('participants')
        .doc(name)
        .set({
          name,
          timezone: userTz,
          availability: availabilityArray
        });
      output.textContent = `Availability saved for ${name}.\nThank you!`;
      loadAllAvailability();
    } catch (err) {
      output.textContent = `Error saving availability: ${err}`;
    }
  }

  // Load and merge all participants availability and update heatmap
  async function loadAllAvailability() {
    mergedAvailability = {}; // Reset

    try {
      const snapshot = await db.collection('events')
        .doc(eventId)
        .collection('participants')
        .get();

      // Count availability per time block
      snapshot.forEach(doc => {
        const data = doc.data();
        if (Array.isArray(data.availability)) {
          data.availability.forEach(time => {
            mergedAvailability[time] = (mergedAvailability[time] || 0) + 1;
          });
        }
      });

      // Update heatmap colors on the grid
      updateHeatmap();
    } catch (err) {
      console.error("Error loading availability:", err);
      output.textContent = "Error loading availability data.";
    }
  }

  // Update grid blocks with heatmap colors and merge user selections
  function updateHeatmap() {
    const blocks = document.querySelectorAll('.block');

    blocks.forEach(block => {
      const time = block.dataset.time;
      const count = mergedAvailability[time] || 0;

      // Clear previous heat classes
      block.classList.remove('heat0', 'heat1', 'heat2', 'heat3', 'heat4', 'heat5plus');

      // Add heat classes based on count (max at 5+)
      if (count === 0) block.classList.add('heat0');
      else if (count === 1) block.classList.add('heat1');
      else if (count === 2) block.classList.add('heat2');
      else if (count === 3) block.classList.add('heat3');
      else if (count === 4) block.classList.add('heat4');
      else block.classList.add('heat5plus');

      // Also keep your own selections outlined
      if (selectedTimes.has(time)) {
        block.classList.add('selected');
      }
    });
  }

  // On page load - set date defaults and build grid if dates set
  window.addEventListener('load', () => {
    const today = DateTime.local().toISODate();
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
  });

  buildGridBtn.addEventListener('click', () => {
    buildGrid();
  });

  submitBtn.addEventListener('click', () => {
    submitAvailability();
  });

  // Load availability automatically when user changes event timezone or dates (optional)
  eventTzSelect.addEventListener('change', () => { if(document.getElementById('startDate').value) buildGrid(); });
  document.getElementById('startDate').addEventListener('change', () => { if(eventTzSelect.value) buildGrid(); });
  document.getElementById('endDate').addEventListener('change', () => { if(eventTzSelect.value) buildGrid(); });

</script>

</body>
</html>
